<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NTD/IDR Currency Trader</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <!-- Firebase SDKs -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged, signInWithCustomToken, signOut } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, onSnapshot, deleteDoc, doc, query, orderBy, Timestamp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Expose Firebase to window for the React app to use
        window.firebaseApp = { initializeApp, getAuth, signInAnonymously, onAuthStateChanged, signInWithCustomToken, signOut, getFirestore, collection, addDoc, onSnapshot, deleteDoc, doc, query, orderBy, Timestamp };
    </script>
</head>
<body class="bg-slate-50 text-slate-900">
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useMemo } = React;
        // Define icons as simple SVG components
        const Plus = ({ size = 24, className = "" }) => (
            <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}>
                <line x1="12" y1="5" x2="12" y2="19"></line>
                <line x1="5" y1="12" x2="19" y2="12"></line>
            </svg>
        );

        const Minus = ({ size = 24, className = "" }) => (
            <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}>
                <line x1="5" y1="12" x2="19" y2="12"></line>
            </svg>
        );

        const ArrowRightLeft = ({ size = 24, className = "" }) => (
            <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}>
                <path d="M17 11H3M3 11L7 7M3 11L7 15M21 13H7M21 13L17 17M21 13L17 9"></path>
            </svg>
        );

        const Wallet = ({ size = 24, className = "" }) => (
            <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}>
                <path d="M21 12V7H5a2 2 0 0 1 0-4h14v4"></path>
                <path d="M3 5v14a2 2 0 0 0 2 2h16v-5"></path>
                <path d="M18 12a2 2 0 0 0 0 4h4v-4Z"></path>
            </svg>
        );

        const TrendingUp = ({ size = 24, className = "" }) => (
            <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}>
                <polyline points="23 6 13.5 15.5 8.5 10.5 1 18"></polyline>
                <polyline points="17 6 23 6 23 12"></polyline>
            </svg>
        );

        const Trash2 = ({ size = 24, className = "" }) => (
            <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}>
                <polyline points="3 6 5 6 21 6"></polyline>
                <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path>
                <line x1="10" y1="11" x2="10" y2="17"></line>
                <line x1="14" y1="11" x2="14" y2="17"></line>
            </svg>
        );

        const History = ({ size = 24, className = "" }) => (
            <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}>
                <path d="M3 12a9 9 0 1 0 9-9 9.75 9.75 0 0 0-6.74 2.74L3 8"></path>
                <path d="M3 3v5h5"></path>
                <path d="M12 7v5l4 2"></path>
            </svg>
        );

        const Loader2 = ({ size = 24, className = "" }) => (
            <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}>
                <path d="M21 12a9 9 0 1 1-6.219-8.56"></path>
            </svg>
        );

        // --- Firebase Configuration ---
        // Note: In a real deployment, these would be your specific project keys.
        // The sandbox environment provides these variables globally.
        const firebaseConfig = {
            apiKey: "AIzaSyA8g9XiwCtpj9h42iQyQ8XeLEdlWP1bG9o",
            authDomain: "currency-trading-6cd9e.firebaseapp.com",
            projectId: "currency-trading-6cd9e",
            storageBucket: "currency-trading-6cd9e.firebasestorage.app",
            messagingSenderId: "22469911951",
            appId: "1:22469911951:web:09cba4ac8db5fab06e17fa",
            measurementId: "G-7EXCF2CZBX"
            };
        const appId = window.__app_id || 'default-app';
        
        // Initialize Firebase
        let auth, db, firebaseInitialized = false;
        try {
            const app = window.firebaseApp.initializeApp(firebaseConfig);
            auth = window.firebaseApp.getAuth(app);
            db = window.firebaseApp.getFirestore(app);
            firebaseInitialized = true;
        } catch (e) {
            console.error("Firebase init error:", e);
        }

        // --- Components ---

        const StatCard = ({ title, value, subtext, type, icon: Icon }) => {
            const isPositive = type === 'positive';
            const isNegative = type === 'negative';
            
            let colorClass = "text-slate-600";
            if (isPositive) colorClass = "text-emerald-600";
            if (isNegative) colorClass = "text-rose-600";

            return (
                <div className="bg-white p-6 rounded-xl shadow-sm border border-slate-100 flex items-start justify-between">
                    <div>
                        <p className="text-sm font-medium text-slate-500 mb-1">{title}</p>
                        <h3 className={`text-2xl font-bold ${colorClass}`}>{value}</h3>
                        {subtext && <p className="text-xs text-slate-400 mt-2">{subtext}</p>}
                    </div>
                    <div className={`p-3 rounded-lg ${isPositive ? 'bg-emerald-50 text-emerald-600' : isNegative ? 'bg-rose-50 text-rose-600' : 'bg-slate-50 text-slate-600'}`}>
                        <Icon size={24} />
                    </div>
                </div>
            );
        };

        const TransactionItem = ({ t, onDelete }) => {
            const isBuyNTD = t.type === 'buy_ntd'; // I bought NTD (Inventory UP, IDR DOWN)
            
            return (
                <div className="flex items-center justify-between p-4 bg-white border border-slate-100 rounded-lg mb-3 hover:shadow-md transition-shadow">
                    <div className="flex items-center gap-4">
                        <div className={`w-10 h-10 rounded-full flex items-center justify-center ${isBuyNTD ? 'bg-emerald-100 text-emerald-600' : 'bg-rose-100 text-rose-600'}`}>
                            {isBuyNTD ? <Plus size={18} /> : <Minus size={18} />}
                        </div>
                        <div>
                            <p className="font-semibold text-slate-800">
                                {isBuyNTD ? 'Bought NTD' : 'Sold NTD'}
                            </p>
                            <p className="text-xs text-slate-500">
                                {t.date ? new Date(t.date.seconds * 1000).toLocaleDateString() : 'Just now'}
                            </p>
                        </div>
                    </div>
                    
                    <div className="text-right">
                        <p className={`font-bold ${isBuyNTD ? 'text-emerald-600' : 'text-rose-600'}`}>
                            {isBuyNTD ? '+' : '-'}{Number(t.amount_ntd).toLocaleString()} NTD
                        </p>
                        <p className="text-sm text-slate-500">
                            @ {Number(t.rate).toLocaleString()} IDR
                        </p>
                        <p className="text-xs font-mono text-slate-400">
                            Total: {Number(t.total_idr).toLocaleString()} IDR
                        </p>
                    </div>

                    <button 
                        onClick={() => onDelete(t.id)}
                        className="ml-4 p-2 text-slate-300 hover:text-rose-500 transition-colors"
                        title="Delete Transaction"
                    >
                        <Trash2 size={16} />
                    </button>
                </div>
            );
        };

        const App = () => {
            const [user, setUser] = useState(null);
            const [transactions, setTransactions] = useState([]);
            const [loading, setLoading] = useState(true);
            const [submitting, setSubmitting] = useState(false);

            // Form State
            const [type, setType] = useState('buy_ntd'); // 'buy_ntd' or 'sell_ntd'
            const [amountNTD, setAmountNTD] = useState('');
            const [rate, setRate] = useState('');
            
            // 1. Auth Logic
            useEffect(() => {
                if (!firebaseInitialized || !auth) {
                    console.warn("Firebase not initialized. Using demo mode.");
                    setUser({ uid: 'demo-user' });
                    setLoading(false);
                    return;
                }

                const initAuth = async () => {
                    try {
                        if (window.__initial_auth_token) {
                            await window.firebaseApp.signInWithCustomToken(auth, window.__initial_auth_token);
                        } else {
                            await window.firebaseApp.signInAnonymously(auth);
                        }
                    } catch (error) {
                        console.error("Auth error:", error);
                        // Fallback to demo mode
                        setUser({ uid: 'demo-user' });
                        setLoading(false);
                    }
                };
                initAuth();

                const unsubscribe = window.firebaseApp.onAuthStateChanged(auth, (u) => {
                    setUser(u);
                    if (!u) setLoading(false);
                });
                return () => unsubscribe();
            }, []);

            // 2. Data Fetching
            useEffect(() => {
                if (!user) return;

                // Demo mode - use localStorage
                if (!firebaseInitialized || !db) {
                    const loadFromStorage = () => {
                        try {
                            const stored = localStorage.getItem('ntd-idr-transactions');
                            if (stored) {
                                const data = JSON.parse(stored);
                                setTransactions(data);
                            }
                        } catch (error) {
                            console.error("Error loading from localStorage:", error);
                        }
                        setLoading(false);
                    };
                    loadFromStorage();
                    return;
                }

                // Firebase mode
                const collectionRef = window.firebaseApp.collection(db, 'artifacts', appId, 'users', user.uid, 'transactions');
                const q = window.firebaseApp.query(collectionRef); 

                const unsubscribe = window.firebaseApp.onSnapshot(q, (snapshot) => {
                    const data = snapshot.docs.map(doc => ({
                        id: doc.id,
                        ...doc.data()
                    }));
                    data.sort((a, b) => (b.date?.seconds || 0) - (a.date?.seconds || 0));
                    setTransactions(data);
                    setLoading(false);
                }, (error) => {
                    console.error("Error fetching transactions:", error);
                    setLoading(false);
                });

                return () => unsubscribe();
            }, [user]);

            // 3. Analysis / Calculations
            const stats = useMemo(() => {
                let ntdBalance = 0;
                let idrNetPosition = 0; // Negative means invested, Positive means profit
                let totalInvestedIDR = 0;
                let totalNTDBought = 0;

                transactions.forEach(t => {
                    const ntd = Number(t.amount_ntd);
                    const idr = Number(t.total_idr);

                    if (t.type === 'buy_ntd') {
                        // Bought NTD: Gain NTD stock, Lose IDR cash
                        ntdBalance += ntd;
                        idrNetPosition -= idr;
                        
                        totalNTDBought += ntd;
                        totalInvestedIDR += idr;
                    } else {
                        // Sold NTD: Lose NTD stock, Gain IDR cash
                        ntdBalance -= ntd;
                        idrNetPosition += idr;
                    }
                });

                const avgBuyRate = totalNTDBought > 0 ? (totalInvestedIDR / totalNTDBought) : 0;
                
                // Break-even logic
                // If I have 100 NTD left, and my Net IDR is -40,000.
                // I need to sell 100 NTD for at least 40,000 to break even (rate 400).
                const breakEvenRate = ntdBalance > 0 && idrNetPosition < 0 
                    ? Math.abs(idrNetPosition) / ntdBalance 
                    : 0;

                return {
                    ntdBalance,
                    idrNetPosition,
                    avgBuyRate,
                    breakEvenRate
                };
            }, [transactions]);

            // 4. Actions
            const handleAddTransaction = async (e) => {
                e.preventDefault();
                if (!user || !amountNTD || !rate) return;
                setSubmitting(true);

                try {
                    const totalIDR = Number(amountNTD) * Number(rate);
                    const newTransaction = {
                        id: Date.now().toString(),
                        type,
                        amount_ntd: Number(amountNTD),
                        rate: Number(rate),
                        total_idr: totalIDR,
                        date: { seconds: Math.floor(Date.now() / 1000) }
                    };

                    if (!firebaseInitialized || !db) {
                        // Demo mode - use localStorage
                        const updated = [newTransaction, ...transactions];
                        setTransactions(updated);
                        localStorage.setItem('ntd-idr-transactions', JSON.stringify(updated));
                    } else {
                        // Firebase mode
                        await window.firebaseApp.addDoc(
                            window.firebaseApp.collection(db, 'artifacts', appId, 'users', user.uid, 'transactions'),
                            {
                                type,
                                amount_ntd: Number(amountNTD),
                                rate: Number(rate),
                                total_idr: totalIDR,
                                date: window.firebaseApp.Timestamp.now()
                            }
                        );
                    }
                    
                    setAmountNTD('');
                } catch (err) {
                    console.error("Error adding doc", err);
                    alert("Failed to save transaction");
                } finally {
                    setSubmitting(false);
                }
            };

            const handleDelete = async (id) => {
                if(!confirm("Are you sure you want to delete this record?")) return;
                try {
                    if (!firebaseInitialized || !db) {
                        // Demo mode - use localStorage
                        const updated = transactions.filter(t => t.id !== id);
                        setTransactions(updated);
                        localStorage.setItem('ntd-idr-transactions', JSON.stringify(updated));
                    } else {
                        // Firebase mode
                        await window.firebaseApp.deleteDoc(
                            window.firebaseApp.doc(db, 'artifacts', appId, 'users', user.uid, 'transactions', id)
                        );
                    }
                } catch (err) {
                    console.error("Error deleting", err);
                }
            };

            // Helpers
            const formatIDR = (num) => "Rp " + num.toLocaleString('id-ID');
            const formatNTD = (num) => "NT$ " + num.toLocaleString('zh-TW');

            if (loading) return (
                <div className="min-h-screen flex items-center justify-center bg-slate-50">
                    <div className="flex flex-col items-center gap-2">
                        <Loader2 className="animate-spin text-blue-600" size={32} />
                        <p className="text-slate-500">Loading your ledger...</p>
                    </div>
                </div>
            );

            return (
                <div className="max-w-4xl mx-auto p-4 md:p-6 pb-20">
                    {/* Header */}
                    <div className="flex flex-col md:flex-row md:items-center justify-between mb-8 gap-4">
                        <div>
                            <h1 className="text-3xl font-bold text-slate-900 flex items-center gap-2">
                                <ArrowRightLeft className="text-blue-600" />
                                NTD/IDR Manager
                            </h1>
                            <p className="text-slate-500 mt-1">
                                User ID: <span className="font-mono bg-slate-200 px-1 rounded text-xs">{user?.uid?.slice(0,8)}...</span>
                            </p>
                        </div>
                    </div>

                    {/* Stats Grid */}
                    <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4 mb-8">
                        <StatCard 
                            title="NTD Inventory (Surplus)" 
                            value={formatNTD(stats.ntdBalance)} 
                            subtext="Total NTD currently in hand"
                            type={stats.ntdBalance > 0 ? 'positive' : 'neutral'}
                            icon={Wallet}
                        />
                        <StatCard 
                            title="IDR Net Position" 
                            value={formatIDR(stats.idrNetPosition)} 
                            subtext={stats.idrNetPosition < 0 ? "Currently Invested" : "Realized Profit"}
                            type={stats.idrNetPosition > 0 ? 'positive' : 'negative'}
                            icon={TrendingUp}
                        />
                        <StatCard 
                            title="Avg Buy Price" 
                            value={formatIDR(stats.avgBuyRate)} 
                            subtext="Per 1 NTD (Weighted)"
                            type="neutral"
                            icon={History}
                        />
                        <StatCard 
                            title="Break-Even Sell Rate" 
                            value={stats.breakEvenRate > 0 ? formatIDR(stats.breakEvenRate) : "N/A"} 
                            subtext="Min sell price to cover costs"
                            type="neutral"
                            icon={ArrowRightLeft}
                        />
                    </div>

                    <div className="grid grid-cols-1 lg:grid-cols-3 gap-8">
                        
                        {/* LEFT COLUMN: Input Form */}
                        <div className="lg:col-span-1">
                            <div className="bg-white p-6 rounded-xl shadow-sm border border-slate-100 sticky top-6">
                                <h2 className="text-xl font-bold mb-4 text-slate-800">New Transaction</h2>
                                <form onSubmit={handleAddTransaction} className="space-y-4">
                                    
                                    {/* Transaction Type Toggle */}
                                    <div className="grid grid-cols-2 gap-2 bg-slate-100 p-1 rounded-lg">
                                        <button
                                            type="button"
                                            onClick={() => setType('buy_ntd')}
                                            className={`py-2 text-sm font-medium rounded-md transition-all ${
                                                type === 'buy_ntd' 
                                                ? 'bg-emerald-500 text-white shadow-sm' 
                                                : 'text-slate-500 hover:text-slate-700'
                                            }`}
                                        >
                                            Buy NTD
                                        </button>
                                        <button
                                            type="button"
                                            onClick={() => setType('sell_ntd')}
                                            className={`py-2 text-sm font-medium rounded-md transition-all ${
                                                type === 'sell_ntd' 
                                                ? 'bg-rose-500 text-white shadow-sm' 
                                                : 'text-slate-500 hover:text-slate-700'
                                            }`}
                                        >
                                            Sell NTD
                                        </button>
                                    </div>

                                    {/* Explanation */}
                                    <div className={`text-xs p-3 rounded border ${type === 'buy_ntd' ? 'bg-emerald-50 border-emerald-100 text-emerald-700' : 'bg-rose-50 border-rose-100 text-rose-700'}`}>
                                        {type === 'buy_ntd' 
                                            ? "You are BUYING NTD. You receive NTD, you pay IDR." 
                                            : "You are SELLING NTD. You give NTD, you receive IDR."}
                                    </div>

                                    {/* Inputs */}
                                    <div>
                                        <label className="block text-sm font-medium text-slate-700 mb-1">
                                            Amount (NTD)
                                        </label>
                                        <div className="relative">
                                            <input
                                                type="number"
                                                required
                                                min="1"
                                                value={amountNTD}
                                                onChange={(e) => setAmountNTD(e.target.value)}
                                                className="w-full p-3 pl-4 pr-12 bg-slate-50 border border-slate-200 rounded-lg focus:ring-2 focus:ring-blue-500 focus:outline-none"
                                                placeholder="e.g. 1000"
                                            />
                                            <span className="absolute right-4 top-3 text-slate-400 text-sm font-bold">NTD</span>
                                        </div>
                                    </div>

                                    <div>
                                        <label className="block text-sm font-medium text-slate-700 mb-1">
                                            Exchange Rate (IDR)
                                        </label>
                                        <div className="relative">
                                            <input
                                                type="number"
                                                required
                                                min="1"
                                                value={rate}
                                                onChange={(e) => setRate(e.target.value)}
                                                className="w-full p-3 pl-4 pr-12 bg-slate-50 border border-slate-200 rounded-lg focus:ring-2 focus:ring-blue-500 focus:outline-none"
                                                placeholder="e.g. 500"
                                            />
                                            <span className="absolute right-4 top-3 text-slate-400 text-sm font-bold">IDR</span>
                                        </div>
                                    </div>

                                    {/* Calculation Preview */}
                                    <div className="pt-2 border-t border-slate-100 mt-2">
                                        <div className="flex justify-between items-center text-sm">
                                            <span className="text-slate-500">Total {type === 'buy_ntd' ? 'Cost' : 'Received'}:</span>
                                            <span className="font-bold text-slate-800">
                                                {amountNTD && rate ? formatIDR(amountNTD * rate) : 'Rp 0'}
                                            </span>
                                        </div>
                                    </div>

                                    <button
                                        type="submit"
                                        disabled={submitting}
                                        className={`w-full py-3 rounded-lg font-bold text-white shadow-lg shadow-blue-500/20 transition-all active:scale-95 ${
                                            submitting ? 'bg-slate-400' : 'bg-blue-600 hover:bg-blue-700'
                                        }`}
                                    >
                                        {submitting ? 'Saving...' : 'Record Transaction'}
                                    </button>
                                </form>
                            </div>
                        </div>

                        {/* RIGHT COLUMN: History */}
                        <div className="lg:col-span-2">
                            <h2 className="text-xl font-bold mb-4 text-slate-800">Transaction History</h2>
                            
                            {transactions.length === 0 ? (
                                <div className="text-center py-12 bg-white rounded-xl border border-dashed border-slate-300">
                                    <div className="bg-slate-50 w-16 h-16 rounded-full flex items-center justify-center mx-auto mb-4 text-slate-400">
                                        <History size={32} />
                                    </div>
                                    <p className="text-slate-500">No transactions yet.</p>
                                    <p className="text-sm text-slate-400">Add your first trade on the left!</p>
                                </div>
                            ) : (
                                <div>
                                    {transactions.map(t => (
                                        <TransactionItem key={t.id} t={t} onDelete={handleDelete} />
                                    ))}
                                </div>
                            )}
                        </div>

                    </div>
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>